var global_bundle_id = 0;
var global_subject_code = 0;
var evaluator_email="abc";
function reapify()
{
 var usn=document.getElementById("usn").value;
 //alert(usn);	
 var type=document.getElementById("type").value;
 var subjectCode=document.getElementById("subjectCode").value;
 //var imageURL="images/"+usn+"/"+type+subjectCode;
 var imageURL="images/"+usn;
 //alert(imageURL);
 var op=document.getElementById("answerImage");
 op.innerHTML=""; 
 var xhr=new XMLHttpRequest();
 filenamesArray='';
 xhr.onreadystatechange=function(){
 	if(xhr.readyState==4 && xhr.status==200){
 		filenames = String(xhr.responseText);
 		//document.write(filenamesArray);
 		//alert(filenames);
 		filenamesArray=JSON.parse(filenames);
 		//alert(filenamesArray);
 		for (i=0;i<filenamesArray.length;i++)
 		{
 			var img=document.createElement("img");
 			var src1="images/"+usn+"/"+filenamesArray[i];
 			alert(src1);
 			img.src=src1;
 			op.appendChild(img);
 			op.appendChild(document.createElement("br"));
 			op.appendChild(document.createElement("br"));
		}
 		//var img=document.createElement("img");
 		//img.src="images/"+usn+"/"+filenamesArray[0];
 		//op.appendChild(img);
 	}
 }
 xhr.open("GET","fetchFileNames.php?path="+imageURL,true);
 xhr.send();
//alert("yes");


}


function reapify2()
{
 var table = document.getElementById("answers");
 table.innerHTML = "";
 var tr = document.createElement("tr");
 var th = document.createElement("th");
 th.innerHTML = "Answers";
 tr.appendChild(th);
 var th = document.createElement("th");
 th.innerHTML = "Comments And Marks";
 tr.appendChild(th);
 table.appendChild(tr);
 var qno = document.getElementById("question_num").value;
 var valid = validate_question_no(qno);
 if(!valid)
 {
 	alert("Invalid Question Number"); 	return;
 }
 else
 {
 	xhr = new XMLHttpRequest();
	xhr.onreadystatechange = getResult;
	xhr.open("GET","http://localhost/REAP/question_and_answer.php?qp_id="+1+"&qno="+qno,false);
	xhr.send();	
 	//make a xhr call to getImageURL.php and return URLs in JSON format
 	result = new Array("images/1pi12cs059/t112cs4051.jpg","images/1pi12cs059/t112cs4052.jpg","images/1pi12cs059/t112cs4053.jpg");
 	fillTable(result,table);
 }
}

function validate_question_no(qno)
{
	if(qno.length > 1 && qno.length < 3)
	{
		if(!isNaN(qno[0]) && qno[1].match(/[a-zA-Z]/))
			return true;
		else
			return false;
	}
	else if(qno.length == 1)
	{
		if(!isNaN(qno[0]))
			return true;
	}
	else
		return false;
}

function getResult()
{
	if(xhr.readyState == 4 && xhr.status == 200)
	{
		result = JSON.parse(xhr.responseText);
		var q = result["question_text"];
 		var a = result["expected_answer"];
 		max_marks = result["max_marks"];
 		var question = document.getElementById("question");
 		question.style.display = "block";
 		document.getElementById("qno").innerHTML = q;
 		document.getElementById("a1").innerHTML = a;
 		var buttons = document.getElementById("outerdiv");
 		buttons.style.position = "absolute";
 		buttons.style.top = question.offsetHeight + 20 + "px";
	}
}

function fillTable(result,table)
{
 	table.style.display = "block";
 	var i;
 	for (i = 0; i < result.length; i++)
 	{
 		image = document.createElement("img");
 		image.src = result[i]; image.id = "image"+i+1; 
 		image.height = "500";  	image.width = "700";
 		image.addEventListener("click", fullscreenMode);
 		tr = document.createElement("tr");
 		td = document.createElement("td");	
 		td.appendChild(image);
 		tr.appendChild(td);
 		td = document.createElement("td");
 		comments = document.createElement("textarea");
 		comments.placeholder = "Comments";
 		comments.rows = "20"; comments.cols = "38";
 		td.appendChild(comments);
 		marks = document.createElement("input");
 		marks.type = "text"; marks.placeholder = "Marks (Max marks : "+max_marks+" )";
 		td.appendChild(marks);
 		tr.appendChild(td);
 		table.appendChild(tr);
 	}
}

function fullscreenMode(event)
{
	var image_id = event.target.id; 
	//$('#fullscreen').css('width', $('document').outerWidth() + 'px');
	var src = event.target.src; //get the source attribute of the clicked image
	alert(src);
    $('#fullscreen img').attr('src', src); //assign it to the tag for your fullscreen div
    $('#fullscreen').fadeIn();
                
    $('#fullscreen').click(function(){
        $(this).fadeOut(); //this will hide the fullscreen div if you click away from the image. 
    });
}

function session_destroy(event)
{
	//event.preventDefault();
	div = document.getElementById("sessionDestroy");
	div.style.display = "block";
}

//I am writing my code
function fetchImagesDetailsByQuestionNumber(questionNumber){
// i ll write the logic behind fetchin the image from folders...for now i am hardcoding url of images
// 1) modify pending_images tabel to add bundle_id
// 2) select top 10 pending_images which are not evaluated and correspond to this bundle_id  (pending_images)
// 3) select see image table to see if evaluation_done = 0 then only fetch url from (image) table
// 4) evaluation complete hote hi pending_images se remove plus insert into completed table   
var imageurls= ["1pi12cs002/t112CS4011a2016.jpg","1pi12cs003/t112CS4011a2016.jpg","1pi12cs004/t112CS4011a2016.jpg","1pi12cs005/t112CS4011a2016.jpg","1pi12cs008/t112CS4011a2016.jpg"];
var imageIds = [10004,10005,10006,10007,10008];
var imageDetails ={"imageurls":imageurls,"imageids":imageIds};
if(questionNumber != "1a") 
  return null;  
return imageDetails;

}

function getQuestionAnswer() {


}

function updateModal(event) {
  //alert("helllo");
  var source = event.target || event.srcElement;
    //alert(source);
    //tells us that the image is the source of event
    //var url = source.src;
    //alert(url);
    var img = document.getElementById("modalImage");
    img.src = source.src;
    //extract question and answer
    var question = "What is OpenStack ?";
    var answer = "OpenStack is a free and open-source software platform for cloud computing, mostly deployed as an infrastructure-as-a-service (IaaS). The software platform consists of interrelated components that control hardware pools of processing, storage, and networking resources throughout a data center";
    var diagram = "1a.jpg";
    var qno="2a";
    var maxMarks=10;
    //these values i will be extracting
    document.getElementById("maxMarks").innerHTML=maxMarks;
    document.getElementById("qno").innerHTML=qno;
    document.getElementById("modalQuestionImage").innerHTML=question;
    document.getElementById("modalAnswerImage").innerHTML=answer;
    var img=document.getElementById("modalDiagramImage");
    img.width = "400";
    img.src="answers/"+diagram;

}

function showAnswerImagesQuestionWise(){
  //Show expected question and answer
  //Upddate expected Question and Answer
  //alert(global_bundle_id);
  //alert(global_subject_code);
  //var subjectCode = document.getElementById("subjectCode");
  var questionNumber = document.getElementById("questionNumber").value;
  //alert(questionNumber);
  updateExpectedQuestionAnswer(questionNumber);
  imageDetails = fetchImagesDetailsByQuestionNumber(questionNumber);
  if(imageDetails == null) {
    return;
  }
  imageurls = (imageDetails['imageurls']);
  imageIds = (imageDetails['imageids']);
  showAnswerImages(imageurls,imageIds);
} 

//subjectCode and bundle_id are global
function updateExpectedQuestionAnswer(questionNumber) {
  // 4) fetch from db expected question and answer
 var xhr= new XMLHttpRequest();
xhr.onreadystatechange= function(){
        if(xhr.readyState==4 && xhr.status==200)
        {
          return_data=xhr.responseText;
          //alert(return_data);
          returnDataArray = JSON.parse(return_data);
          var expected_answer = returnDataArray['expectedAnswer'];
          //var diagram = "1a.jpg";
          var question_text = returnDataArray['questionText'];
          var maxMarks = returnDataArray['maxMarks'];
          var questionId = returnDataArray['question_id'];
          var iframe = document.getElementById("expectedQuestionAnswerFrame");
          var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
          var k =(innerDoc.getElementById("expectedQuestionInFrame"));
          innerDoc.getElementById("expectedQuestionInFrame").innerHTML=question_text;
          //innerDoc.getElementById("expectedAnswerInFrame").style.whiteSpace = "nowrap";
          innerDoc.getElementById("expectedAnswerInFrame").innerHTML=expected_answer;
          //var img=innerDoc.getElementById("expectedDiagramImageInFrame");
          //img.width = "400";
          //img.src="answers/"+diagram;
        }
      
  }//end of function
  //
  xhr.open("GET","fetchingData/questionDetails.php?questionNumber="+questionNumber+"&subjectCode="+global_subject_code, true);
  xhr.send();

  //var expected_answer = "OpenStack is a free and open-source software platform for cloud computing, mostly deployed as an infrastructure-as-a-service (IaaS). The software platform consists of interrelated components that control hardware pools of processing, storage, and networking resources throughout a data center";
  //var diagram = "1a.jpg";
  //var question_text = "What is OpenStack ?";
  //var iframe = document.getElementById("expectedQuestionAnswerFrame");
  //alert(iframe);
  //var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
  //alert(innerDoc);
  //var k =(innerDoc.getElementById("expectedQuestionInFrame"));
  //alert(k);
  //alert("ok");
  //var items = innerDoc.getElementsByTagName("*");
  //for(i=0 ;i<items.length;i++) {
    //alert(items[i]);
  //}
  //innerDoc.getElementById("expectedQuestionInFrame").innerHTML=question_text;
  //innerDoc.getElementById("expectedAnswerInFrame").innerHTML=expected_answer;
  //var img=innerDoc.getElementById("expectedDiagramImageInFrame");
  //img.width = "400";
  //img.src="answers/"+diagram;
}

function showAnswerImages(imagerls,imageIds) {
 var l=imageurls.length;
 var iframe = document.getElementById("answerFrame");
 var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
 var table =innerDoc.getElementById("imagesTable");
 for(i=0; i<l;i++) {
   var tr1 = innerDoc.createElement("tr");
    var td1 = innerDoc.createElement("td");
      var img=innerDoc.createElement("img");
      img.src = "images/"+imageurls[i];
      img.width=800;
      td1.appendChild(img);
      td1.setAttribute("rowspan",3);
    tr1.appendChild(td1);
      var td2 = innerDoc.createElement("td");
        //td2.innerHTML = "Comment";
        var a = document.createElement("a");
        a.setAttribute('data-toggle', "modal");
        a.href = "#myModal";
        //alert("hello");
        a.innerHTML = "Write a comment";
        td2.appendChild(a);
    tr1.appendChild(td2); 
    
    table.appendChild(tr1);
    //till now row 1 is appended
    var tr2 = innerDoc.createElement("tr");
      var td1 = innerDoc.createElement("td");
      //td1.innerHTML="";
      //5)fetchMaximumMarks...
      var max = 5;
      var ip=innerDoc.createElement("input");
      ip.id=imageIds[i];
      //alert(ip.id);
      ip.type="number";
      ip.placeholder=max;
      ip.style = "width: 60px;maxlength:2";
      td1.appendChild(ip);
    tr2.appendChild(td1);
    table.appendChild(tr2);
    var tr3 = innerDoc.createElement("tr");
      var td1 = innerDoc.createElement("td");
      td1.innerHTML="Report an issue !!";
    tr3.appendChild(td1);
    //tr3.style = "outline: thin solid blue";
    table.appendChild(tr3);
    var dummyRow =innerDoc.createElement("tr");
     var td=innerDoc.createElement("td");
     td.innerHTML="";
     td.style = "background:yellow";
    dummyRow.style = "outline: thick solid black"; 
    dummyRow.appendChild(td);
    table.appendChild(dummyRow);
     


   /*
   var tr1 = innerDoc.createElement("tr");
      var td1 = innerDoc.createElement("td");
        var img=innerDoc.createElement("img");
        img.src = "images/"+imageurls[i];
        //img.setAttribute("width",1000);
        img.width=900;
      td1.appendChild(img);
    tr1.appendChild(td1);
        var td2 = innerDoc.createElement("td");
        //td2.innerHTML = "Comment";
        var a = document.createElement("a");
        a.setAttribute('data-toggle', "modal");
        a.href = "#myModal";
        a.innerHTML = "comment";
        td2.appendChild(a);
        
  tr1.appendChild(td2);
  tr1.style = "outline: thin solid blue";
  table.appendChild(tr1);
  */
  }
}

function startEvaluation() {
  var xhr= new XMLHttpRequest();
  xhr.onreadystatechange= function(){
        if(xhr.readyState==4 && xhr.status==200)
        {
          return_data=xhr.responseText;
          //var new_label=document.createElement("pre");
         //new_label.style.fontFamily="Verdana";
          //new_label.innerHTML=return_data;
          //display_modal_body.appendChild(new_label);
          returnArray =JSON.parse(xhr.responseText);
          bundleArray = returnArray['bundle_id'];
          codeArray = returnArray['subject_code'];
          l=bundleArray.length;
          //var body = document.getElementById("bundleModalBody");
          var body = document.getElementById("bundleDialog");
          body.innerHTML = ""; 
          var h1=document.createElement("h1");
          h1.innerHTML="Select The bundle";
          h1.style="color:red";
          body.appendChild(h1);
          body.style.height="500px";
          body.style.width= "1000px";
          body.style.position = "absolute";
          body.style.top = "100px";

          for(i=0;i<l;i++) {
            var h=document.createElement("h4");
            h.innerHTML=bundleArray[i] + "      "+codeArray[i];
            h.onclick = showAnswerImagesQuestionWisePre;
            h.onHover = "red"
            body.appendChild(h);
          }
          document.getElementById("bundleDialog").showModal();

          
          //var bundle_id=prompt
          
          //showAnswerImagesQuestionWise();
        
        
        }
      
      }//end of function
      xhr.open("GET","fetchingData/evaluatorBundleListing.php", true);
      xhr.send();
  //<?php include('evaluator_bundleListing.php'); ?>
  //bundleArray = String(<?php echo json_encode($bundle_id);?>);
  //subjectCodeArray = String(<?php echo json_encode($bundle_id);?>);
  //alert(bundleArray);
  //alert(subjectCodeArray);
  
}

function showAnswerImagesQuestionWisePre(event) {
  var source = event.target || event.srcElement;
  var sourceString = (source.innerHTML);
  var b= sourceString.split(" ");
  //alert(b);
  var bundle_id = b[0].trim();
  var subject_code=b[b.length-1].trim();
  //alert(bundle_id);
  //alert(subject_code);
  global_subject_code=subject_code;
  global_bundle_id=bundle_id;
  document.getElementById("bundleDialog").close();

  //showAnswerImagesQuestionWise();

}


function reset() {

}


function save() {
 //alert("all set");
 var iframe = document.getElementById("answerFrame");
 var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
 var marksTags= innerDoc.getElementsByTagName("input");
 var r="";
 for(i=0;i<marksTags.length;i++) {
   var id=marksTags[i].id;
   var value=marksTags[i].value;
   if(Number.isInteger(id) && value != null)  
     r=r+"("+id+","+value+")";

 }
 alert(r);
 //alert(marksTags);
 //alert(marksTags.length); 

}